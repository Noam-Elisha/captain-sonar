<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Lobby ‚Äì Admiral Radar</title>
  <link rel="stylesheet" href="/static/css/base.css"/>
  <style>
    body { background:var(--bg-deep); min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:2rem 1rem; }
    h1 { color:var(--accent); letter-spacing:.15em; margin:0 0 .25rem; }
    .game-code { color:var(--text-muted); font-size:.9rem; margin-bottom:2rem; }
    .game-code span { color:var(--text); font-weight:700; letter-spacing:.2em; font-size:1.1rem; }

    .lobby-grid { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; width:100%; max-width:820px; }
    @media(max-width:600px){ .lobby-grid{grid-template-columns:1fr;} }

    .team-panel {
      background:var(--bg-panel); border:1px solid var(--border); border-radius:12px; padding:1.2rem;
    }
    .team-panel.blue { border-top:3px solid var(--blue); background:rgba(37,99,235,.04); }
    .team-panel.red  { border-top:3px solid var(--red);  background:rgba(220,38,38,.04); }
    .team-panel h2 { margin:0 0 1rem; font-size:.95rem; letter-spacing:.1em; }
    .team-panel.blue h2 { color:var(--blue-light); }
    .team-panel.red h2  { color:var(--red-light); }

    .player-slot {
      display:flex; align-items:center; gap:.6rem;
      padding:.5rem .6rem; border-radius:8px; margin-bottom:.4rem;
      background:rgba(255,255,255,.04);
    }
    .player-slot.bot-slot { background:rgba(200,168,50,.06); border:1px solid #3d321044; }
    .player-slot .role-badge {
      font-size:.7rem; padding:.15rem .45rem; border-radius:4px;
      background:var(--bg-deep); border:1px solid var(--border);
      color:var(--text-muted); letter-spacing:.05em; white-space:nowrap;
    }
    .player-slot .ready-dot {
      width:8px; height:8px; border-radius:50%; background:var(--text-muted); margin-left:auto;
    }
    .player-slot .ready-dot.ready { background:#4ade80; }
    .player-slot .player-name { font-size:.9rem; flex:1; }
    .btn-remove-bot {
      padding:.15rem .45rem; border:1px solid #c8a83244; border-radius:5px;
      background:transparent; color:#c8a832; cursor:pointer; font-size:.7rem;
    }
    .btn-remove-bot:hover { background:#3d3210; }

    /* Add-bot row */
    .add-bot-section {
      margin-top:.75rem; padding-top:.75rem; border-top:1px dashed var(--border);
    }
    .add-bot-label {
      font-size:.68rem; letter-spacing:.08em; color:var(--text-muted);
      text-transform:uppercase; margin-bottom:.5rem;
    }
    .add-bot-grid { display:grid; grid-template-columns:1fr 1fr; gap:.35rem; }
    .btn-add-bot {
      padding:.4rem .5rem; border:1px solid #3d3210; border-radius:7px;
      background:rgba(200,168,50,.07); color:#c8a832; cursor:pointer;
      font-size:.75rem; letter-spacing:.04em; transition:all .2s;
      text-align:left;
    }
    .btn-add-bot:hover:not(:disabled) { background:rgba(200,168,50,.18); border-color:#c8a832; }
    .btn-add-bot:disabled { opacity:.35; cursor:not-allowed; }

    .controls { background:var(--bg-panel); border:1px solid var(--border); border-radius:12px;
                padding:1.5rem; max-width:820px; width:100%; margin-top:1.5rem; }
    .controls h2 { color:var(--accent); letter-spacing:.1em; margin:0 0 1rem; font-size:.95rem; }

    .role-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:.6rem; margin-bottom:1rem; }
    .role-btn {
      padding:.6rem; border:1px solid var(--border); border-radius:8px; background:transparent;
      color:var(--text-muted); cursor:pointer; font-size:.85rem; letter-spacing:.04em;
      transition:all .2s;
    }
    .role-btn:hover  { border-color:var(--accent); color:var(--text); }
    .role-btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .role-btn:disabled { opacity:.35; cursor:not-allowed; }

    .team-row { display:flex; gap:.6rem; margin-bottom:1rem; }
    .team-btn {
      flex:1; padding:.6rem; border-radius:8px; border:1px solid var(--border);
      background:transparent; color:var(--text-muted); cursor:pointer; font-size:.85rem;
      transition:all .2s;
    }
    .team-btn.blue.active { background:var(--blue); border-color:var(--blue); color:#fff; }
    .team-btn.red.active  { background:var(--red);  border-color:var(--red);  color:#fff; }

    .action-row { display:flex; gap:.6rem; }
    .btn-ready  { flex:1; padding:.7rem; border-radius:8px; border:none; font-size:.95rem; font-weight:600; cursor:pointer; }
    .btn-ready.not-ready { background:var(--accent); color:#fff; }
    .btn-ready.is-ready  { background:#4ade80; color:#052e16; }
    .btn-start { flex:1; padding:.7rem; border-radius:8px; border:none; font-size:.95rem;
                 font-weight:600; cursor:pointer; background:#c8a832; color:#111; }
    .btn-start:disabled { opacity:.4; cursor:not-allowed; }

    .status-bar { color:var(--text-muted); font-size:.8rem; text-align:center; margin-top:1rem; min-height:1em; }

    /* Spectator panel */
    .spectators-panel {
      background:var(--bg-panel); border:1px solid var(--border); border-radius:12px;
      padding:1.2rem; max-width:820px; width:100%; margin-top:1rem;
      border-top: 3px solid #c8a832;
    }
    .spectators-panel h2 { color:#c8a832; letter-spacing:.1em; margin:0 0 .6rem; font-size:.85rem; }
    .spec-list { display:flex; flex-wrap:wrap; gap:.4rem; min-height:1.5em; }
    .spec-badge {
      padding:.25rem .6rem; border-radius:999px; background:rgba(200,168,50,.15);
      border:1px solid rgba(200,168,50,.3); color:#c8a832; font-size:.78rem;
    }
    .spectator-mode-bar {
      background:rgba(200,168,50,.12); border:1px solid rgba(200,168,50,.3);
      border-radius:10px; padding:1rem 1.2rem; max-width:820px; width:100%;
      margin-top:1rem; display:none;
    }
    .spectator-mode-bar p { color:#c8a832; margin:0 0 .5rem; font-size:.9rem; }
    .btn-leave-spec {
      padding:.45rem 1rem; border:1px solid rgba(200,168,50,.4); border-radius:7px;
      background:transparent; color:#c8a832; cursor:pointer; font-size:.82rem;
    }
    .btn-leave-spec:hover { background:rgba(200,168,50,.2); }
    .btn-spec {
      flex:1; padding:.7rem; border-radius:8px; border:none; font-size:.95rem;
      font-weight:600; cursor:pointer; background:#c8a832; color:#111;
    }
    .btn-spec:disabled { opacity:.4; cursor:not-allowed; }

    .map-editor {
      background:var(--bg-panel); border:1px solid var(--border); border-radius:12px;
      padding:1.2rem; max-width:820px; width:100%; margin-top:1rem;
      border-top:3px solid var(--accent);
    }
    .map-editor h2 { color:var(--accent); letter-spacing:.1em; margin:0 0 1rem; font-size:.95rem; }
    .map-controls { display:grid; grid-template-columns:1fr 1fr; gap:.6rem; margin-bottom:1rem; }
    .slider-group label { display:block; font-size:.78rem; color:var(--text-muted); margin-bottom:.2rem; }
    .slider-group label span { color:var(--text); font-weight:700; }
    .slider-group input[type=range] { width:100%; accent-color:var(--accent); }
    .btn-shuffle {
      grid-column:span 2; padding:.5rem; border:1px solid var(--border); border-radius:7px;
      background:rgba(200,168,50,.07); color:#c8a832; cursor:pointer; font-size:.8rem;
    }
    .btn-shuffle:hover { background:rgba(200,168,50,.18); }
    .map-preview-container { text-align:center; }
    #map-preview { border:1px solid var(--border); border-radius:8px; background:var(--bg-deep); max-width:100%; }
  </style>
</head>
<body>
  <h1>üõ∏ LOBBY</h1>
  <p class="game-code">Game Code: <span id="code-display">{{ game_id }}</span></p>

  <div class="lobby-grid">
    <div class="team-panel blue">
      <h2>üîµ BLUE TEAM</h2>
      <div id="blue-slots"></div>
      <div class="add-bot-section" id="blue-bot-panel" style="display:none">
        <p class="add-bot-label">ü§ñ Add Bot</p>
        <div class="add-bot-grid" id="blue-bot-grid"></div>
      </div>
    </div>
    <div class="team-panel red">
      <h2>üî¥ RED TEAM</h2>
      <div id="red-slots"></div>
      <div class="add-bot-section" id="red-bot-panel" style="display:none">
        <p class="add-bot-label">ü§ñ Add Bot</p>
        <div class="add-bot-grid" id="red-bot-grid"></div>
      </div>
    </div>
  </div>

  <!-- Spectators list -->
  <div class="spectators-panel">
    <h2>üëÅ SPECTATORS</h2>
    <div class="spec-list" id="spec-list">
      <span style="color:var(--text-muted);font-size:.8rem">No spectators yet</span>
    </div>
  </div>

  <!-- Spectator mode bar (shown when YOU are a spectator) -->
  <div class="spectator-mode-bar" id="spectator-mode-bar">
    <p>üëÅ <strong>You are watching as spectator.</strong> When the game starts you'll see everything ‚Äî both submarines, all systems, and the full map.</p>
    <button class="btn-leave-spec" onclick="leaveSpectator()">‚Üê Join as Player Instead</button>
  </div>

  <!-- Map Preview (visible to all) -->
  <div class="map-editor" id="map-preview-section">
    <h2>MAP PREVIEW</h2>
    <div class="map-preview-container">
      <canvas id="map-preview" width="300" height="300"></canvas>
      <div id="map-info" style="text-align:center;font-size:.75rem;color:var(--text-muted);margin-top:.3rem;"></div>
    </div>
  </div>

  <!-- Map Controls (host only) -->
  <div class="map-editor" id="map-editor" style="display:none">
    <h2>MAP SETTINGS</h2>
    <div class="map-controls">
      <div class="slider-group">
        <label>Rows: <span id="val-rows">15</span></label>
        <input type="range" id="sl-rows" min="5" max="30" value="15">
      </div>
      <div class="slider-group">
        <label>Columns: <span id="val-cols">15</span></label>
        <input type="range" id="sl-cols" min="5" max="30" value="15">
      </div>
      <div class="slider-group">
        <label>Sector Width: <span id="val-sw">5</span></label>
        <input type="range" id="sl-sw" min="2" max="10" value="5">
      </div>
      <div class="slider-group">
        <label>Sector Height: <span id="val-sh">5</span></label>
        <input type="range" id="sl-sh" min="2" max="10" value="5">
      </div>
      <div class="slider-group">
        <label>Islands: <span id="val-islands">12</span></label>
        <input type="range" id="sl-islands" min="1" max="30" value="12">
      </div>
      <div class="slider-group">
        <label>Max Island Size: <span id="val-isz">2</span></label>
        <input type="range" id="sl-isz" min="1" max="5" value="2">
      </div>
      <button class="btn-shuffle" onclick="shuffleIslands()">Shuffle Islands</button>
    </div>
  </div>

  <div class="controls" id="player-controls">
    <h2>YOUR SETTINGS</h2>
    <div class="team-row">
      <button class="team-btn blue" id="btn-blue" onclick="chooseTeam('blue')">üîµ Blue Team</button>
      <button class="team-btn red"  id="btn-red"  onclick="chooseTeam('red')">üî¥ Red Team</button>
    </div>
    <p style="color:var(--text-muted);font-size:.78rem;margin:.1rem 0 .6rem;">CHOOSE ROLE</p>
    <div class="role-grid" id="role-grid">
      <button class="role-btn" id="role-captain"        onclick="chooseRole('captain')">üåü Captain</button>
      <button class="role-btn" id="role-first_mate"     onclick="chooseRole('first_mate')">‚öî First Mate</button>
      <button class="role-btn" id="role-engineer"       onclick="chooseRole('engineer')">‚ö° Engineer</button>
      <button class="role-btn" id="role-radio_operator" onclick="chooseRole('radio_operator')">üì° Radio Operator</button>
    </div>
    <div class="action-row">
      <button class="btn-ready not-ready" id="btn-ready" onclick="toggleReady()">Ready Up</button>
      <button class="btn-start" id="btn-start" onclick="startGame()" disabled>Start Game</button>
      <button class="btn-spec"  id="btn-spectate" onclick="joinAsSpectator()">üëÅ Watch</button>
    </div>
    <p class="status-bar" id="status-bar">Waiting for players‚Ä¶</p>
  </div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
  const GAME_ID   = "{{ game_id }}";
  const MY_NAME   = "{{ player_name }}";
  const ROLE_LABELS = {
    captain: 'üåü Captain', first_mate: '‚öî First Mate',
    engineer: '‚ö° Engineer', radio_operator: 'üì° Radio Op'
  };
  const ALL_ROLES = ['captain', 'first_mate', 'engineer', 'radio_operator'];

  let myTeam = 'blue', myRole = '', myReady = false;
  let isHost = false;
  let isSpectator = false;
  let lobbyPlayers = [];
  let lobbySpectators = [];

  const socket = io();
  socket.on('connect', () => {
    socket.emit('join_room', {game_id: GAME_ID});
    socket.emit('join_game', {game_id: GAME_ID, name: MY_NAME});
  });

  socket.on('lobby_state', data => {
    lobbyPlayers   = data.players    || [];
    lobbySpectators = data.spectators || [];
    isHost = (data.host === MY_NAME);
    // Check if I became a spectator
    if (lobbySpectators.some(s => s.name === MY_NAME)) {
      isSpectator = true;
    }
    // Sync map preview from host's settings (for late joiners / non-hosts)
    if (data.map_settings && !isHost) {
      mapSettings = data.map_settings;
      previewIslands = (data.map_settings.islands || []);
      drawMapPreview();
    }
    renderLobby();
  });

  socket.on('spectator_ack', data => {
    isSpectator = true;
    renderLobby();
  });

  socket.on('game_started', data => {
    if (isSpectator) {
      window.location.href = `/spectate?game_id=${GAME_ID}&name=${encodeURIComponent(MY_NAME)}`;
    } else {
      window.location.href = `/play?game_id=${GAME_ID}&name=${encodeURIComponent(MY_NAME)}`;
    }
  });

  socket.on('error', d => {
    document.getElementById('status-bar').textContent = '‚ö† ' + d.msg;
    document.getElementById('status-bar').style.color = '#f87171';
  });

  socket.on('bot_added', d => {
    // Server will send lobby_state update automatically
  });

  function renderLobby() {
    const blue = lobbyPlayers.filter(p => p.team === 'blue');
    const red  = lobbyPlayers.filter(p => p.team === 'red');
    renderTeam('blue-slots', blue, 'blue');
    renderTeam('red-slots',  red,  'red');

    // Spectator list
    const specList = document.getElementById('spec-list');
    if (specList) {
      specList.innerHTML = '';
      if (lobbySpectators.length === 0) {
        specList.innerHTML = '<span style="color:var(--text-muted);font-size:.8rem">No spectators yet</span>';
      } else {
        lobbySpectators.forEach(s => {
          const badge = document.createElement('span');
          badge.className = 'spec-badge';
          badge.textContent = 'üëÅ ' + s.name + (s.name === MY_NAME ? ' (you)' : '');
          specList.appendChild(badge);
        });
      }
    }

    // Show/hide spectator vs player controls
    const specBar     = document.getElementById('spectator-mode-bar');
    const playerCtrl  = document.getElementById('player-controls');
    if (isSpectator) {
      if (specBar)    specBar.style.display    = '';
      if (playerCtrl) playerCtrl.style.display = 'none';
      return;
    }
    if (specBar)    specBar.style.display    = 'none';
    if (playerCtrl) playerCtrl.style.display = '';

    // Update my local state from server data
    const me = lobbyPlayers.find(p => p.name === MY_NAME);
    if (me) {
      myTeam  = me.team  || 'blue';
      myRole  = me.role  || '';
      myReady = me.ready || false;
    }

    // Team buttons
    document.getElementById('btn-blue').classList.toggle('active', myTeam==='blue');
    document.getElementById('btn-red').classList.toggle('active',  myTeam==='red');

    // Role buttons ‚Äî disable roles taken by others on my team (including bots)
    const takenOnMyTeam = lobbyPlayers
      .filter(p => p.team === myTeam && p.name !== MY_NAME)
      .map(p => p.role);
    ALL_ROLES.forEach(r => {
      const btn = document.getElementById('role-'+r);
      btn.classList.toggle('active', myRole === r);
      btn.disabled = (r !== myRole && takenOnMyTeam.includes(r));
    });

    // Ready button
    const readyBtn = document.getElementById('btn-ready');
    readyBtn.textContent  = myReady ? '‚úì Ready!' : 'Ready Up';
    readyBtn.className    = 'btn-ready ' + (myReady ? 'is-ready' : 'not-ready');
    readyBtn.disabled     = !myRole;

    // Start button: host only; everyone (humans) must be ready
    const humanPlayers = lobbyPlayers.filter(p => !p.is_bot);
    const allHumansReady = humanPlayers.length >= 1 && humanPlayers.every(p => p.ready);
    const canStart = isHost && allHumansReady && lobbyPlayers.length >= 2;
    document.getElementById('btn-start').disabled = !canStart;
    if (!isHost) document.getElementById('btn-start').style.display = 'none';

    // Status
    const notReady = lobbyPlayers.filter(p => !p.ready && !p.is_bot);
    if (notReady.length > 0) {
      document.getElementById('status-bar').textContent =
        `Waiting for: ${notReady.map(p=>p.name).join(', ')}`;
      document.getElementById('status-bar').style.color = '';
    } else if (lobbyPlayers.length >= 2) {
      document.getElementById('status-bar').textContent = 'All ready! Host can launch the game.';
      document.getElementById('status-bar').style.color = '#4ade80';
    }

    // Bot panels (host only)
    renderBotPanel('blue', blue);
    renderBotPanel('red',  red);

    // Show map controls for host only; preview is always visible
    const mapEditor = document.getElementById('map-editor');
    if (mapEditor) {
      mapEditor.style.display = isHost ? '' : 'none';
    }
  }

  function renderTeam(containerId, players, team) {
    const el = document.getElementById(containerId);
    el.innerHTML = '';
    if (players.length === 0) {
      el.innerHTML = '<p style="color:var(--text-muted);font-size:.8rem;padding:.4rem">No players yet</p>';
      return;
    }
    players.forEach(p => {
      const slot = document.createElement('div');
      const isBot = p.is_bot;
      slot.className = 'player-slot' + (isBot ? ' bot-slot' : '');

      const nameHtml = isBot
        ? `<span class="player-name" style="color:#c8a832;font-style:italic">ü§ñ ${p.name}</span>`
        : `<span class="player-name">${p.name}${p.name===MY_NAME?' <em style="opacity:.5">(you)</em>':''}</span>`;

      const removeBtn = (isBot && isHost)
        ? `<button class="btn-remove-bot" onclick="removeBot('${p.name}')">‚úï</button>`
        : '';

      slot.innerHTML = `
        ${nameHtml}
        <span class="role-badge">${ROLE_LABELS[p.role] || 'No role'}</span>
        ${removeBtn}
        <span class="ready-dot ${p.ready?'ready':''}"></span>
      `;
      el.appendChild(slot);
    });
  }

  function renderBotPanel(team, players) {
    const panel = document.getElementById(team + '-bot-panel');
    const grid  = document.getElementById(team + '-bot-grid');
    if (!isHost) { panel.style.display = 'none'; return; }
    panel.style.display = '';

    const takenRoles = players.map(p => p.role);
    const total = lobbyPlayers.length;

    grid.innerHTML = '';
    ALL_ROLES.forEach(role => {
      const taken = takenRoles.includes(role);
      const full  = total >= 8;
      const btn = document.createElement('button');
      btn.className = 'btn-add-bot';
      btn.disabled  = taken || full;
      btn.textContent = taken
        ? `${ROLE_LABELS[role]} ‚úì`
        : `+ ${ROLE_LABELS[role]}`;
      btn.onclick = () => addBot(team, role);
      grid.appendChild(btn);
    });
  }

  function chooseTeam(team) {
    if (myTeam === team) return;
    socket.emit('set_team', {game_id: GAME_ID, name: MY_NAME, team});
  }

  function chooseRole(role) {
    const newRole = (myRole === role) ? '' : role;
    socket.emit('set_role', {game_id: GAME_ID, name: MY_NAME, role: newRole});
  }

  function toggleReady() {
    socket.emit('player_ready', {game_id: GAME_ID, name: MY_NAME, ready: !myReady});
  }

  function addBot(team, role) {
    socket.emit('add_bot', {game_id: GAME_ID, name: MY_NAME, team, role});
  }

  function removeBot(botName) {
    socket.emit('remove_bot', {game_id: GAME_ID, name: MY_NAME, bot_name: botName});
  }

  function startGame() {
    socket.emit('start_game', {game_id: GAME_ID, name: MY_NAME});
  }

  function joinAsSpectator() {
    socket.emit('join_as_spectator', {game_id: GAME_ID, name: MY_NAME});
  }

  function leaveSpectator() {
    // Re-join as a regular player
    isSpectator = false;
    socket.emit('join_game', {game_id: GAME_ID, name: MY_NAME});
    renderLobby();
  }

  // ‚îÄ‚îÄ Map Editor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let mapSettings = { rows: 15, cols: 15, sector_width: 5, sector_height: 5, num_islands: 12, island_size: 2 };
  let previewIslands = [];

  function initMapEditor() {
    const ids = ['rows', 'cols', 'sw', 'sh', 'islands', 'isz'];
    ids.forEach(id => {
      const sl = document.getElementById('sl-' + id);
      if (sl) sl.addEventListener('input', onSliderChange);
    });
    generatePreviewIslands();
    drawMapPreview();
  }

  function onSliderChange() {
    let rows = +document.getElementById('sl-rows').value;
    let cols = +document.getElementById('sl-cols').value;
    let sw = +document.getElementById('sl-sw').value;
    let sh = +document.getElementById('sl-sh').value;

    // Snap dimensions to be divisible by sector size
    rows = Math.max(sh, Math.round(rows / sh) * sh);
    cols = Math.max(sw, Math.round(cols / sw) * sw);
    document.getElementById('sl-rows').value = rows;
    document.getElementById('sl-cols').value = cols;

    // Cap islands at 10% of map area
    const maxIslands = Math.floor(rows * cols * 0.1);
    const islandSlider = document.getElementById('sl-islands');
    islandSlider.max = maxIslands;
    if (+islandSlider.value > maxIslands) islandSlider.value = maxIslands;

    mapSettings = {
      rows, cols, sector_width: sw, sector_height: sh,
      num_islands: +document.getElementById('sl-islands').value,
      island_size: +document.getElementById('sl-isz').value,
    };

    // Update labels
    document.getElementById('val-rows').textContent = rows;
    document.getElementById('val-cols').textContent = cols;
    document.getElementById('val-sw').textContent = sw;
    document.getElementById('val-sh').textContent = sh;
    document.getElementById('val-islands').textContent = mapSettings.num_islands;
    document.getElementById('val-isz').textContent = mapSettings.island_size;

    generatePreviewIslands();
    drawMapPreview();
    emitMapSettings();
  }

  function shuffleIslands() {
    generatePreviewIslands();
    drawMapPreview();
    emitMapSettings();
  }

  function generatePreviewIslands() {
    const { rows, cols, num_islands, island_size } = mapSettings;
    const set = new Set();
    const max = Math.min(num_islands, Math.floor(rows * cols * 0.1));

    for (let i = 0; i < max; i++) {
      let r, c, attempts = 0;
      do {
        r = 1 + Math.floor(Math.random() * (rows - 2));
        c = 1 + Math.floor(Math.random() * (cols - 2));
        attempts++;
      } while (set.has(`${r},${c}`) && attempts < 50);
      if (attempts >= 50) continue;

      let size = 1;
      if (island_size >= 2 && Math.random() < 0.15) {
        size = 2 + Math.floor(Math.random() * (island_size - 1));
      }

      for (let di = 0; di < size; di++) {
        for (let dj = 0; dj < size; dj++) {
          const nr = r + di, nc = c + dj;
          if (nr > 0 && nr < rows - 1 && nc > 0 && nc < cols - 1) {
            if (size >= 3 && (di === 0 || di === size-1) && (dj === 0 || dj === size-1)) {
              if (Math.random() < 0.4) continue;
            }
            set.add(`${nr},${nc}`);
          }
        }
      }
    }

    previewIslands = [...set].map(s => s.split(',').map(Number));
  }

  function drawMapPreview() {
    const canvas = document.getElementById('map-preview');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const { rows, cols, sector_width, sector_height } = mapSettings;

    const maxW = 300, maxH = 300;
    const cellW = Math.floor(maxW / cols);
    const cellH = Math.floor(maxH / rows);
    const cell = Math.min(cellW, cellH, 20);
    canvas.width = cols * cell;
    canvas.height = rows * cell;

    // Background
    ctx.fillStyle = '#1a1a2e';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Grid lines
    ctx.strokeStyle = 'rgba(255,255,255,0.08)';
    ctx.lineWidth = 0.5;
    for (let r = 0; r <= rows; r++) {
      ctx.beginPath(); ctx.moveTo(0, r * cell); ctx.lineTo(cols * cell, r * cell); ctx.stroke();
    }
    for (let c = 0; c <= cols; c++) {
      ctx.beginPath(); ctx.moveTo(c * cell, 0); ctx.lineTo(c * cell, rows * cell); ctx.stroke();
    }

    // Sector boundaries
    ctx.strokeStyle = 'rgba(200,168,50,0.5)';
    ctx.lineWidth = 2;
    for (let sr = 0; sr <= Math.ceil(rows / sector_height); sr++) {
      const y = Math.min(sr * sector_height, rows) * cell;
      ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(cols * cell, y); ctx.stroke();
    }
    for (let sc = 0; sc <= Math.ceil(cols / sector_width); sc++) {
      const x = Math.min(sc * sector_width, cols) * cell;
      ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, rows * cell); ctx.stroke();
    }

    // Sector labels
    ctx.fillStyle = 'rgba(200,168,50,0.6)';
    ctx.font = `${Math.max(cell * 0.8, 10)}px monospace`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    let sNum = 1;
    for (let sr = 0; sr < Math.ceil(rows / sector_height); sr++) {
      for (let sc = 0; sc < Math.ceil(cols / sector_width); sc++) {
        const cx = (sc * sector_width + Math.min(sector_width, cols - sc * sector_width) / 2) * cell;
        const cy = (sr * sector_height + Math.min(sector_height, rows - sr * sector_height) / 2) * cell;
        ctx.fillText(sNum++, cx, cy);
      }
    }

    // Islands
    ctx.fillStyle = '#8B4513';
    previewIslands.forEach(([r, c]) => {
      ctx.fillRect(c * cell + 1, r * cell + 1, cell - 2, cell - 2);
    });

    // Update info line
    const sectorsPerRow = Math.ceil(cols / sector_width);
    const sectorsPerCol = Math.ceil(rows / sector_height);
    const totalSectors = sectorsPerRow * sectorsPerCol;
    const info = document.getElementById('map-info');
    if (info) info.textContent = `${rows}x${cols} grid | ${totalSectors} sectors | ${previewIslands.length} islands`;
  }

  function emitMapSettings() {
    if (!isHost) return;
    mapSettings.islands = previewIslands;
    socket.emit('map_settings', { game_id: GAME_ID, name: MY_NAME, settings: mapSettings });
  }

  // Listen for map settings updates from host
  socket.on('map_settings_update', data => {
    if (!isHost) {
      mapSettings = data.settings;
      previewIslands = (data.settings.islands || []);
      drawMapPreview();
    }
  });

  // Initialize map editor on load
  document.addEventListener('DOMContentLoaded', initMapEditor);
</script>
</body>
</html>
