<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Lobby ‚Äì Captain Sonar</title>
  <link rel="stylesheet" href="/static/css/base.css"/>
  <style>
    body { background:var(--bg-deep); min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:2rem 1rem; }
    h1 { color:var(--accent); letter-spacing:.15em; margin:0 0 .25rem; }
    .game-code { color:var(--text-muted); font-size:.9rem; margin-bottom:2rem; }
    .game-code span { color:var(--text); font-weight:700; letter-spacing:.2em; font-size:1.1rem; }

    .lobby-grid { display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; width:100%; max-width:820px; }
    @media(max-width:600px){ .lobby-grid{grid-template-columns:1fr;} }

    .team-panel {
      background:var(--bg-panel); border:1px solid var(--border); border-radius:12px; padding:1.2rem;
    }
    .team-panel.blue { border-top:3px solid var(--blue); background:rgba(37,99,235,.04); }
    .team-panel.red  { border-top:3px solid var(--red);  background:rgba(220,38,38,.04); }
    .team-panel h2 { margin:0 0 1rem; font-size:.95rem; letter-spacing:.1em; }
    .team-panel.blue h2 { color:var(--blue-light); }
    .team-panel.red h2  { color:var(--red-light); }

    .player-slot {
      display:flex; align-items:center; gap:.6rem;
      padding:.5rem .6rem; border-radius:8px; margin-bottom:.4rem;
      background:rgba(255,255,255,.04);
    }
    .player-slot.bot-slot { background:rgba(167,139,250,.06); border:1px solid #3b1f6e44; }
    .player-slot .role-badge {
      font-size:.7rem; padding:.15rem .45rem; border-radius:4px;
      background:var(--bg-deep); border:1px solid var(--border);
      color:var(--text-muted); letter-spacing:.05em; white-space:nowrap;
    }
    .player-slot .ready-dot {
      width:8px; height:8px; border-radius:50%; background:var(--text-muted); margin-left:auto;
    }
    .player-slot .ready-dot.ready { background:#4ade80; }
    .player-slot .player-name { font-size:.9rem; flex:1; }
    .btn-remove-bot {
      padding:.15rem .45rem; border:1px solid #7c3aed44; border-radius:5px;
      background:transparent; color:#a78bfa; cursor:pointer; font-size:.7rem;
    }
    .btn-remove-bot:hover { background:#3b1f6e; }

    /* Add-bot row */
    .add-bot-section {
      margin-top:.75rem; padding-top:.75rem; border-top:1px dashed var(--border);
    }
    .add-bot-label {
      font-size:.68rem; letter-spacing:.08em; color:var(--text-muted);
      text-transform:uppercase; margin-bottom:.5rem;
    }
    .add-bot-grid { display:grid; grid-template-columns:1fr 1fr; gap:.35rem; }
    .btn-add-bot {
      padding:.4rem .5rem; border:1px solid #3b1f6e; border-radius:7px;
      background:rgba(167,139,250,.07); color:#a78bfa; cursor:pointer;
      font-size:.75rem; letter-spacing:.04em; transition:all .2s;
      text-align:left;
    }
    .btn-add-bot:hover:not(:disabled) { background:rgba(167,139,250,.18); border-color:#7c3aed; }
    .btn-add-bot:disabled { opacity:.35; cursor:not-allowed; }

    .controls { background:var(--bg-panel); border:1px solid var(--border); border-radius:12px;
                padding:1.5rem; max-width:820px; width:100%; margin-top:1.5rem; }
    .controls h2 { color:var(--accent); letter-spacing:.1em; margin:0 0 1rem; font-size:.95rem; }

    .role-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:.6rem; margin-bottom:1rem; }
    .role-btn {
      padding:.6rem; border:1px solid var(--border); border-radius:8px; background:transparent;
      color:var(--text-muted); cursor:pointer; font-size:.85rem; letter-spacing:.04em;
      transition:all .2s;
    }
    .role-btn:hover  { border-color:var(--accent); color:var(--text); }
    .role-btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .role-btn:disabled { opacity:.35; cursor:not-allowed; }

    .team-row { display:flex; gap:.6rem; margin-bottom:1rem; }
    .team-btn {
      flex:1; padding:.6rem; border-radius:8px; border:1px solid var(--border);
      background:transparent; color:var(--text-muted); cursor:pointer; font-size:.85rem;
      transition:all .2s;
    }
    .team-btn.blue.active { background:var(--blue); border-color:var(--blue); color:#fff; }
    .team-btn.red.active  { background:var(--red);  border-color:var(--red);  color:#fff; }

    .action-row { display:flex; gap:.6rem; }
    .btn-ready  { flex:1; padding:.7rem; border-radius:8px; border:none; font-size:.95rem; font-weight:600; cursor:pointer; }
    .btn-ready.not-ready { background:var(--accent); color:#fff; }
    .btn-ready.is-ready  { background:#4ade80; color:#052e16; }
    .btn-start { flex:1; padding:.7rem; border-radius:8px; border:none; font-size:.95rem;
                 font-weight:600; cursor:pointer; background:#7c3aed; color:#fff; }
    .btn-start:disabled { opacity:.4; cursor:not-allowed; }

    .status-bar { color:var(--text-muted); font-size:.8rem; text-align:center; margin-top:1rem; min-height:1em; }

    /* Spectator panel */
    .spectators-panel {
      background:var(--bg-panel); border:1px solid var(--border); border-radius:12px;
      padding:1.2rem; max-width:820px; width:100%; margin-top:1rem;
      border-top: 3px solid #7c3aed;
    }
    .spectators-panel h2 { color:#a78bfa; letter-spacing:.1em; margin:0 0 .6rem; font-size:.85rem; }
    .spec-list { display:flex; flex-wrap:wrap; gap:.4rem; min-height:1.5em; }
    .spec-badge {
      padding:.25rem .6rem; border-radius:999px; background:rgba(124,58,237,.15);
      border:1px solid rgba(124,58,237,.3); color:#a78bfa; font-size:.78rem;
    }
    .spectator-mode-bar {
      background:rgba(124,58,237,.12); border:1px solid rgba(124,58,237,.3);
      border-radius:10px; padding:1rem 1.2rem; max-width:820px; width:100%;
      margin-top:1rem; display:none;
    }
    .spectator-mode-bar p { color:#a78bfa; margin:0 0 .5rem; font-size:.9rem; }
    .btn-leave-spec {
      padding:.45rem 1rem; border:1px solid rgba(124,58,237,.4); border-radius:7px;
      background:transparent; color:#a78bfa; cursor:pointer; font-size:.82rem;
    }
    .btn-leave-spec:hover { background:rgba(124,58,237,.2); }
    .btn-spec {
      flex:1; padding:.7rem; border-radius:8px; border:none; font-size:.95rem;
      font-weight:600; cursor:pointer; background:#7c3aed; color:#fff;
    }
    .btn-spec:disabled { opacity:.4; cursor:not-allowed; }
  </style>
</head>
<body>
  <h1>‚öì LOBBY</h1>
  <p class="game-code">Game Code: <span id="code-display">{{ game_id }}</span></p>

  <div class="lobby-grid">
    <div class="team-panel blue">
      <h2>üîµ BLUE TEAM</h2>
      <div id="blue-slots"></div>
      <div class="add-bot-section" id="blue-bot-panel" style="display:none">
        <p class="add-bot-label">ü§ñ Add Bot</p>
        <div class="add-bot-grid" id="blue-bot-grid"></div>
      </div>
    </div>
    <div class="team-panel red">
      <h2>üî¥ RED TEAM</h2>
      <div id="red-slots"></div>
      <div class="add-bot-section" id="red-bot-panel" style="display:none">
        <p class="add-bot-label">ü§ñ Add Bot</p>
        <div class="add-bot-grid" id="red-bot-grid"></div>
      </div>
    </div>
  </div>

  <!-- Spectators list -->
  <div class="spectators-panel">
    <h2>üëÅ SPECTATORS</h2>
    <div class="spec-list" id="spec-list">
      <span style="color:var(--text-muted);font-size:.8rem">No spectators yet</span>
    </div>
  </div>

  <!-- Spectator mode bar (shown when YOU are a spectator) -->
  <div class="spectator-mode-bar" id="spectator-mode-bar">
    <p>üëÅ <strong>You are watching as spectator.</strong> When the game starts you'll see everything ‚Äî both submarines, all systems, and the full map.</p>
    <button class="btn-leave-spec" onclick="leaveSpectator()">‚Üê Join as Player Instead</button>
  </div>

  <div class="controls" id="player-controls">
    <h2>YOUR SETTINGS</h2>
    <div class="team-row">
      <button class="team-btn blue" id="btn-blue" onclick="chooseTeam('blue')">üîµ Blue Team</button>
      <button class="team-btn red"  id="btn-red"  onclick="chooseTeam('red')">üî¥ Red Team</button>
    </div>
    <p style="color:var(--text-muted);font-size:.78rem;margin:.1rem 0 .6rem;">CHOOSE ROLE</p>
    <div class="role-grid" id="role-grid">
      <button class="role-btn" id="role-captain"        onclick="chooseRole('captain')">üéñ Captain</button>
      <button class="role-btn" id="role-first_mate"     onclick="chooseRole('first_mate')">‚öô First Mate</button>
      <button class="role-btn" id="role-engineer"       onclick="chooseRole('engineer')">üîß Engineer</button>
      <button class="role-btn" id="role-radio_operator" onclick="chooseRole('radio_operator')">üì° Radio Operator</button>
    </div>
    <div class="action-row">
      <button class="btn-ready not-ready" id="btn-ready" onclick="toggleReady()">Ready Up</button>
      <button class="btn-start" id="btn-start" onclick="startGame()" disabled>Start Game</button>
      <button class="btn-spec"  id="btn-spectate" onclick="joinAsSpectator()">üëÅ Watch</button>
    </div>
    <p class="status-bar" id="status-bar">Waiting for players‚Ä¶</p>
  </div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
  const GAME_ID   = "{{ game_id }}";
  const MY_NAME   = "{{ player_name }}";
  const ROLE_LABELS = {
    captain: 'üéñ Captain', first_mate: '‚öô First Mate',
    engineer: 'üîß Engineer', radio_operator: 'üì° Radio Op'
  };
  const ALL_ROLES = ['captain', 'first_mate', 'engineer', 'radio_operator'];

  let myTeam = 'blue', myRole = '', myReady = false;
  let isHost = false;
  let isSpectator = false;
  let lobbyPlayers = [];
  let lobbySpectators = [];

  const socket = io();
  socket.on('connect', () => {
    socket.emit('join_room', {game_id: GAME_ID});
    socket.emit('join_game', {game_id: GAME_ID, name: MY_NAME});
  });

  socket.on('lobby_state', data => {
    lobbyPlayers   = data.players    || [];
    lobbySpectators = data.spectators || [];
    isHost = (data.host === MY_NAME);
    // Check if I became a spectator
    if (lobbySpectators.some(s => s.name === MY_NAME)) {
      isSpectator = true;
    }
    renderLobby();
  });

  socket.on('spectator_ack', data => {
    isSpectator = true;
    renderLobby();
  });

  socket.on('game_started', data => {
    if (isSpectator) {
      window.location.href = `/spectate?game_id=${GAME_ID}&name=${encodeURIComponent(MY_NAME)}`;
    } else {
      window.location.href = `/play?game_id=${GAME_ID}&name=${encodeURIComponent(MY_NAME)}`;
    }
  });

  socket.on('error', d => {
    document.getElementById('status-bar').textContent = '‚ö† ' + d.msg;
    document.getElementById('status-bar').style.color = '#f87171';
  });

  socket.on('bot_added', d => {
    // Server will send lobby_state update automatically
  });

  function renderLobby() {
    const blue = lobbyPlayers.filter(p => p.team === 'blue');
    const red  = lobbyPlayers.filter(p => p.team === 'red');
    renderTeam('blue-slots', blue, 'blue');
    renderTeam('red-slots',  red,  'red');

    // Spectator list
    const specList = document.getElementById('spec-list');
    if (specList) {
      specList.innerHTML = '';
      if (lobbySpectators.length === 0) {
        specList.innerHTML = '<span style="color:var(--text-muted);font-size:.8rem">No spectators yet</span>';
      } else {
        lobbySpectators.forEach(s => {
          const badge = document.createElement('span');
          badge.className = 'spec-badge';
          badge.textContent = 'üëÅ ' + s.name + (s.name === MY_NAME ? ' (you)' : '');
          specList.appendChild(badge);
        });
      }
    }

    // Show/hide spectator vs player controls
    const specBar     = document.getElementById('spectator-mode-bar');
    const playerCtrl  = document.getElementById('player-controls');
    if (isSpectator) {
      if (specBar)    specBar.style.display    = '';
      if (playerCtrl) playerCtrl.style.display = 'none';
      return;
    }
    if (specBar)    specBar.style.display    = 'none';
    if (playerCtrl) playerCtrl.style.display = '';

    // Update my local state from server data
    const me = lobbyPlayers.find(p => p.name === MY_NAME);
    if (me) {
      myTeam  = me.team  || 'blue';
      myRole  = me.role  || '';
      myReady = me.ready || false;
    }

    // Team buttons
    document.getElementById('btn-blue').classList.toggle('active', myTeam==='blue');
    document.getElementById('btn-red').classList.toggle('active',  myTeam==='red');

    // Role buttons ‚Äî disable roles taken by others on my team (including bots)
    const takenOnMyTeam = lobbyPlayers
      .filter(p => p.team === myTeam && p.name !== MY_NAME)
      .map(p => p.role);
    ALL_ROLES.forEach(r => {
      const btn = document.getElementById('role-'+r);
      btn.classList.toggle('active', myRole === r);
      btn.disabled = (r !== myRole && takenOnMyTeam.includes(r));
    });

    // Ready button
    const readyBtn = document.getElementById('btn-ready');
    readyBtn.textContent  = myReady ? '‚úì Ready!' : 'Ready Up';
    readyBtn.className    = 'btn-ready ' + (myReady ? 'is-ready' : 'not-ready');
    readyBtn.disabled     = !myRole;

    // Start button: host only; everyone (humans) must be ready
    const humanPlayers = lobbyPlayers.filter(p => !p.is_bot);
    const allHumansReady = humanPlayers.length >= 1 && humanPlayers.every(p => p.ready);
    // Also need minimum team structure (server enforces this, but give a hint)
    const canStart = isHost && allHumansReady && lobbyPlayers.length >= 2;
    document.getElementById('btn-start').disabled = !canStart;
    if (!isHost) document.getElementById('btn-start').style.display = 'none';

    // Status
    const notReady = lobbyPlayers.filter(p => !p.ready && !p.is_bot);
    if (notReady.length > 0) {
      document.getElementById('status-bar').textContent =
        `Waiting for: ${notReady.map(p=>p.name).join(', ')}`;
      document.getElementById('status-bar').style.color = '';
    } else if (lobbyPlayers.length >= 2) {
      document.getElementById('status-bar').textContent = 'All ready! Host can start the game.';
      document.getElementById('status-bar').style.color = '#4ade80';
    }

    // Bot panels (host only)
    renderBotPanel('blue', blue);
    renderBotPanel('red',  red);
  }

  function renderTeam(containerId, players, team) {
    const el = document.getElementById(containerId);
    el.innerHTML = '';
    if (players.length === 0) {
      el.innerHTML = '<p style="color:var(--text-muted);font-size:.8rem;padding:.4rem">No players yet</p>';
      return;
    }
    players.forEach(p => {
      const slot = document.createElement('div');
      const isBot = p.is_bot;
      slot.className = 'player-slot' + (isBot ? ' bot-slot' : '');

      const nameHtml = isBot
        ? `<span class="player-name" style="color:#a78bfa;font-style:italic">ü§ñ ${p.name}</span>`
        : `<span class="player-name">${p.name}${p.name===MY_NAME?' <em style="opacity:.5">(you)</em>':''}</span>`;

      const removeBtn = (isBot && isHost)
        ? `<button class="btn-remove-bot" onclick="removeBot('${p.name}')">‚úï</button>`
        : '';

      slot.innerHTML = `
        ${nameHtml}
        <span class="role-badge">${ROLE_LABELS[p.role] || 'No role'}</span>
        ${removeBtn}
        <span class="ready-dot ${p.ready?'ready':''}"></span>
      `;
      el.appendChild(slot);
    });
  }

  function renderBotPanel(team, players) {
    const panel = document.getElementById(team + '-bot-panel');
    const grid  = document.getElementById(team + '-bot-grid');
    if (!isHost) { panel.style.display = 'none'; return; }
    panel.style.display = '';

    const takenRoles = players.map(p => p.role);
    const total = lobbyPlayers.length;

    grid.innerHTML = '';
    ALL_ROLES.forEach(role => {
      const taken = takenRoles.includes(role);
      const full  = total >= 8;
      const btn = document.createElement('button');
      btn.className = 'btn-add-bot';
      btn.disabled  = taken || full;
      btn.textContent = taken
        ? `${ROLE_LABELS[role]} ‚úì`
        : `+ ${ROLE_LABELS[role]}`;
      btn.onclick = () => addBot(team, role);
      grid.appendChild(btn);
    });
  }

  function chooseTeam(team) {
    if (myTeam === team) return;
    socket.emit('set_team', {game_id: GAME_ID, name: MY_NAME, team});
  }

  function chooseRole(role) {
    const newRole = (myRole === role) ? '' : role;
    socket.emit('set_role', {game_id: GAME_ID, name: MY_NAME, role: newRole});
  }

  function toggleReady() {
    socket.emit('player_ready', {game_id: GAME_ID, name: MY_NAME, ready: !myReady});
  }

  function addBot(team, role) {
    socket.emit('add_bot', {game_id: GAME_ID, name: MY_NAME, team, role});
  }

  function removeBot(botName) {
    socket.emit('remove_bot', {game_id: GAME_ID, name: MY_NAME, bot_name: botName});
  }

  function startGame() {
    socket.emit('start_game', {game_id: GAME_ID, name: MY_NAME});
  }

  function joinAsSpectator() {
    socket.emit('join_as_spectator', {game_id: GAME_ID, name: MY_NAME});
  }

  function leaveSpectator() {
    // Re-join as a regular player
    isSpectator = false;
    socket.emit('join_game', {game_id: GAME_ID, name: MY_NAME});
    renderLobby();
  }
</script>
</body>
</html>
