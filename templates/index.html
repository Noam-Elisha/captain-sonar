<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Captain Sonar</title>
  <link rel="stylesheet" href="/static/css/base.css"/>
  <style>
    body { display:flex; align-items:center; justify-content:center; min-height:100vh; background:var(--bg-deep); }
    .card {
      background:var(--bg-panel); border:1px solid var(--border);
      border-radius:16px; padding:2.5rem 3rem; max-width:460px; width:100%;
      box-shadow:0 8px 40px rgba(0,0,0,.6);
    }
    .logo { text-align:center; margin-bottom:2rem; }
    .logo h1 { font-size:2.2rem; letter-spacing:.15em; color:var(--accent); margin:0; }
    .logo p  { color:var(--text-muted); font-size:.85rem; margin:.25rem 0 0; letter-spacing:.1em; }
    .tabs { display:flex; gap:.5rem; margin-bottom:1.5rem; }
    .tab-btn {
      flex:1; padding:.6rem; border:1px solid var(--border); border-radius:8px;
      background:transparent; color:var(--text-muted); cursor:pointer; font-size:.9rem;
      transition:all .2s;
    }
    .tab-btn.active { background:var(--accent); color:#fff; border-color:var(--accent); }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    label { display:block; margin-bottom:.3rem; color:var(--text-muted); font-size:.8rem; letter-spacing:.05em; }
    input[type=text] {
      width:100%; box-sizing:border-box; padding:.7rem 1rem;
      background:var(--bg-input); border:1px solid var(--border); border-radius:8px;
      color:var(--text); font-size:1rem; margin-bottom:1rem; outline:none;
      transition:border-color .2s;
    }
    input[type=text]:focus { border-color:var(--accent); }
    .btn-primary {
      width:100%; padding:.8rem; background:var(--accent); color:#fff;
      border:none; border-radius:8px; font-size:1rem; font-weight:600;
      cursor:pointer; transition:opacity .2s; letter-spacing:.05em;
    }
    .btn-primary:hover { opacity:.85; }
    .error-msg { color:#f87171; font-size:.85rem; margin-top:.5rem; min-height:1.2em; }
    .divider { border:none; border-top:1px solid var(--border); margin:1.5rem 0; }
    .code-hint { font-size:.8rem; color:var(--text-muted); text-align:center; }
  </style>
</head>
<body>
<div class="card">
  <div class="logo">
    <h1>‚öì CAPTAIN SONAR</h1>
    <p>TURN-BASED MULTIPLAYER</p>
  </div>

  <div class="tabs">
    <button class="tab-btn active" id="tab-create" onclick="switchTab('create')">Create Game</button>
    <button class="tab-btn"        id="tab-join"   onclick="switchTab('join')">Join Game</button>
    <button class="tab-btn"        id="tab-spectate" onclick="switchTab('spectate')">üëÅ Spectate</button>
  </div>

  <!-- Create -->
  <div class="tab-content active" id="pane-create">
    <label for="create-name">YOUR NAME</label>
    <input type="text" id="create-name" placeholder="e.g. Captain Jack" maxlength="24"/>
    <button class="btn-primary" onclick="createGame()">Create Game</button>
    <p class="error-msg" id="create-error"></p>
  </div>

  <!-- Join -->
  <div class="tab-content" id="pane-join">
    <label for="join-name">YOUR NAME</label>
    <input type="text" id="join-name" placeholder="e.g. Navigator Sam" maxlength="24"/>
    <label for="join-code">GAME CODE</label>
    <input type="text" id="join-code" placeholder="6-character code" maxlength="6"
           style="text-transform:uppercase"/>
    <button class="btn-primary" onclick="joinGame()">Join Game</button>
    <p class="error-msg" id="join-error"></p>
  </div>

  <!-- Spectate -->
  <div class="tab-content" id="pane-spectate">
    <label for="spec-name">YOUR NAME</label>
    <input type="text" id="spec-name" placeholder="e.g. Observer" maxlength="24"/>
    <label for="spec-code">GAME CODE</label>
    <input type="text" id="spec-code" placeholder="6-character code" maxlength="6"
           style="text-transform:uppercase"/>
    <button class="btn-primary" onclick="spectateGame()" style="background:#7c3aed">üëÅ Watch Game</button>
    <p class="error-msg" id="spectate-error"></p>
    <p style="color:var(--text-muted);font-size:.75rem;margin-top:.6rem;text-align:center;">
      You'll see both submarines &amp; all game info ‚Äî no role needed
    </p>
  </div>

  <hr class="divider"/>
  <p class="code-hint">Needs 2‚Äì8 players ¬∑ Each team needs Captain, First Mate &amp; Engineer</p>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
  const socket = io();

  function switchTab(t) {
    ['create','join','spectate'].forEach(id => {
      document.getElementById('tab-'+id).classList.toggle('active', id===t);
      document.getElementById('pane-'+id).classList.toggle('active', id===t);
    });
  }

  function createGame() {
    const name = document.getElementById('create-name').value.trim();
    if (!name) return showErr('create','Enter your name');
    socket.emit('create_game', {name});
  }

  function joinGame() {
    const name = document.getElementById('join-name').value.trim();
    const code = document.getElementById('join-code').value.trim().toUpperCase();
    if (!name) return showErr('join','Enter your name');
    if (code.length !== 6) return showErr('join','Enter the 6-character game code');
    socket.emit('join_game', {name, game_id: code});
  }

  function showErr(tab, msg) {
    document.getElementById(tab+'-error').textContent = msg;
  }

  function spectateGame() {
    const name = document.getElementById('spec-name').value.trim();
    const code = document.getElementById('spec-code').value.trim().toUpperCase();
    if (!name) return showErr('spectate', 'Enter your name');
    if (code.length !== 6) return showErr('spectate', 'Enter the 6-character game code');
    socket.emit('join_as_spectator', {name, game_id: code});
  }

  socket.on('game_created', d => {
    window.location.href = `/lobby?game_id=${d.game_id}&name=${encodeURIComponent(d.name)}`;
  });
  socket.on('join_ack', d => {
    window.location.href = `/lobby?game_id=${d.game_id}&name=${encodeURIComponent(d.name)}`;
  });
  socket.on('spectator_ack', d => {
    window.location.href = `/spectate?game_id=${d.game_id}&name=${encodeURIComponent(d.name)}`;
  });
  socket.on('error', d => {
    const active = ['create','join','spectate'].find(t =>
      document.getElementById('pane-'+t)?.classList.contains('active'));
    showErr(active || 'join', d.msg);
  });

  // Enter key support
  document.addEventListener('keydown', e => {
    if (e.key !== 'Enter') return;
    if (document.getElementById('pane-create').classList.contains('active'))   createGame();
    else if (document.getElementById('pane-join').classList.contains('active')) joinGame();
    else spectateGame();
  });
</script>
</body>
</html>
